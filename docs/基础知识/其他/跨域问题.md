# 跨域问题

### 跨域问题

- 背景：前后端分离模式
  
    例子：
    
    - server-a 提供静态资源
    - server-b 提供基于HTTP的API
- 同源策略
    - 当通过xhr的方式去从一个源去获取另一个源的数据时，就会触发同源策略的协议
        - 源：协议+主机（ip/域名）+端口，如：http://localhost:8888
        - 同源策略：浏览器的一种安全机制，避免浏览器通过脚本等方式去获取非同源的数据。
- 跨域解决方案：CORS
    - 这套机制建立在一个核心内容基础上：http header，定义了一系列的HTTP头，通过这些HTTP头来控制资源的访问。
    - 这些头基本以access-control-？来命名，不同的HTTP头有不同作用。
    
    [跨源资源共享（CORS） - HTTP | MDN](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS)
    
    1. 非普通的资源请求
        1. 简单请求
            1. 当满足一定规则时，为普通请求
            
            [跨源资源共享（CORS） - HTTP | MDN](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS#%E7%AE%80%E5%8D%95%E8%AF%B7%E6%B1%82)
            
        2. 预检请求
            1. 满足非简单请求，先发送method为options的请求，称为预检，后端需要对这个预检请求进行处理，返回对应的头信息，告知客户端是否允许发送非简单请求。
            
            [跨源资源共享（CORS） - HTTP | MDN](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/CORS#%E9%A2%84%E6%A3%80%E8%AF%B7%E6%B1%82)
    
- 跨域解决方案：后端代理
    - 除了js能通过一些API发送HTTP请求，其他语言也可以实现，同源策略仅仅是浏览器下的某种策略机制，其他语言不受限制，所以我们可以利用静态资源（也就是js发送请求所在的资源服务器）去发送请求，然后进行转发，我们称为“代理”。
    - 正向代理
        - {客户端脚本 （xhr）} ⇒ {API服务器} ：跨域
        - {客户端脚本（xhr）⇒ 代理 } ⇒ {API服务器}：跨域
    - 反向代理
        - {客户端（xhr）} ⇒ { 代理 ⇒ API服务器 } ：跨域
    - 使用第三方中间件
        - koa-server-http-proxy（正向代理）
        
        ```javascript
        const Koa = require('koa')
        const app = new Koa()
        const proxy = require('koa-server-http-proxy')
        app.use(proxy('/api', {
          target: 'https://news-at.zhihu.com',
        	//把当前请求的path转成目标服务器实际path
          pathRewrite: { '^/api': '' },
          changeOrigin: true
        })) 
        app.listen(3000)
        ```
    
- 跨域凭证信息处理
    - 基于Cookie的CORS处理
        - cookie实际上也会受到同源策略的限制，如果是非同源请求，cookie是默认被禁止携带的。
    
    附带身份凭证的请求
    
    - 客户端在请求中设置：withCredentials : true
    - 服务端要在cros中设置：ctx.set('Assess-Control-Allow-Credentials' , 'true')
    - 基于Token的鉴权机制
      
        基于Cookie的验证会存在一些问题：
        
        - 无论当前请求是否需要传输Cookie，浏览器都会主动发送（浪费）
        - 容易被CSRF攻击
        - **JWT介绍**
            - Json web token，为了在网络应用环境间传递声明而执行的一种基于JSON的开发标准。
            
            [JWT.IO - JSON Web Tokens Introduction](https://jwt.io/introduction/)
            
            - 组成结构：由通过 . 链接的三段文本信息构成。
            
            ```javascript
            let header = {
              "alg": "HS256",
              "typ": "JWT"
            }
            let payload = {
              "sub": "1234567890",
              "name": "John Doe",
              "admin": true
            }
            let sign = HMACSHA256(
              base64UrlEncode(header) + "." +
              base64UrlEncode(payload),
              secret)
            
            let token = `${base64UrlEncode(header)}.${base64UrlEncode(payload)}.${sign}`;
            ```
            
            - 使用jsonwebtoken
            
            ```javascript
            //生成token
            const jwt = require('jsonwebtoken');
            let key = 'merlin'
            let token = jwt.sign({ uid: 1 }, key);
            
            ctx.set('Aythorization',token)
            
            //验证token
            try {
              let uid = jwt.verify(token, key);
            } catch(err) {
              // err
            }
            ```