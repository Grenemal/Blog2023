# 网络安全防范

## XSS

将可执行的代码注入到网页。

### 攻击类型
- 持久性
	- 将代码写入数据库
	- 危害性大
- 非持久性
	- 通过修改`URL`参数的方式加入攻击代码，诱导用户访问链接进行攻击
	- 如：`http://www.domain.com?name=<script>alert(1)</script>`

### 防范方式
1. 转义字符，将`引号`、`尖括号`、`斜杠`进行转义
```js
function escape(str) {
  str = str.replace(/&/g, '&amp;')
  str = str.replace(/</g, '&lt;')
  str = str.replace(/>/g, '&gt;')
  str = str.replace(/"/g, '&quto;')
  str = str.replace(/'/g, '&#39;')
  str = str.replace(/`/g, '&#96;')
  str = str.replace(/\//g, '&#x2F;')
  return str
}
```
对于富文本来说，使用白名单的过滤方法
```js
const xss = require('xss')
let html = xss('<h1 id="title">XSS Demo</h1><script>alert("xss");</script>')
// -> <h1>XSS Demo</h1>&lt;script&gt;alert("xss");&lt;/script&gt;
console.log(html)
```

使用 `js-xss` 来实现，可以看到在输出中保留了 `h1` 标签且过滤了 `script` 标签。

2. CSP建立白名单，告诉浏览器哪些外部资源可以加载和运行，配置好规则，减少XSS攻击。兼容性不错。
	- 开启CSP的方法
		1. 设置`HTTP Header`中的`Content-Security-Policy`
			1. `default-src 'self'`只允许本站资源
			2. `img-src https://*`只允许加载HTTPS协议图片
			3. `child-src 'none'`允许加载任何来源框架
			4. [更多请查看文档](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Headers/Content-Security-Policy)
		2. 设置`<meta>`标签的方式`<meta http-equiv="Content-Security-Policy" >`

## CSRF

跨站请求伪造。原理就是攻击者构造出一个后端请求地址，诱导用户点击或者通过某些途径自动发起请求。如果用户是在登录状态下的话，后端就以为是用户在操作，从而进行相应的逻辑。

防范 CSRF 攻击可以遵循以下几种规则：
- `GET`请求不对数据进行修改
- 不允许第三方网站访问用户的`Cookie`
- 阻止第三方网站请求接口
- 请求时附带验证信息比如`验证码`或者`Token`

- SameSite
	- 可以对Cookie设置SameSite。该属性表示Cookie不随跨域请求发送
	- 可以很大程度减少`CSRF`的攻击，但该属性目前并不是所以浏览器都支持
- 验证`Referer`
	- 通过验证来判断请求是否为第三方网站发起的
- Token
	- 服务器下发一个随机token，每次发起请求时将Token携带上，服务器验证Token是否有效

## 点击劫持

攻击者将需要攻击的网站通过`iframe`嵌套在自己的网页中，并且将`iframe`设置为透明，在页面中透出一个按钮诱导用户点击。

防御方法：
- 设置`X-FRAME_OPTIONS`，这个HTTP响应头就是为了防御iframe嵌套的点击劫持攻击
	- `DENY`表示页面**不允许**用过iframe的方式展示
	- `SAMEORIGIN`表示页面可以在**相同域名**下通过iframe的方式展示
	- `ALLOW_FROM`表示页面可以在**指定来源**的iframe中展示
- JS防御
```html
<head>
  <style id="click-jack">
    html {
      display: none !important;
    }
  </style>
</head>
<body>
  <script>
	// 如果该网页为普通页面
	// self表示自身窗口的引用，top表示最顶层的浏览器窗口的引用
    if (self == top) {
      var style = document.getElementById('click-jack')
      document.body.removeChild(style)
    } else {
      top.location = self.location
    }
  </script>
</body>
```

以上代码表示：当通过iframe的方式加载页面时，攻击者的网页直接显示所有内容。

## 中间人攻击

中间人攻击是攻击方同时与服务端和客户端建立起了连接，并让对方认为连接是安全的，但是实际上整个通信过程都被攻击者控制了。攻击者不仅能获得双方的通信信息，还能修改通信信息。

通常来说`不建议使用公共的 Wi-Fi`，因为很可能就会发生中间人攻击的情况。如果你在通信的过程中涉及到了某些敏感信息，就完全暴露给攻击方了。

当然防御中间人攻击其实并不难，只需要增加一个安全通道来传输信息。`HTTPS 就可以用来防御中间人攻击`，但是并不是说使用了 HTTPS 就可以高枕无忧了，因为如果你没有完全关闭 HTTP 访问的话，攻击方可以通过某些方式`将 HTTPS 降级为 HTTP` 从而实现中间人攻击。